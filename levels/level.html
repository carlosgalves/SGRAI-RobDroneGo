<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>SGRAI - RobDroneGo</title>
    <link rel="stylesheet" href="styles.css">
    <script src="info_panels.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10"></link>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>

<body>

<div id="elevatorPopup" class="popup">
    <span class="close-btn" onclick="closeElevatorPopup()">X</span>
    <p>Change to a different level</p>

    <div id="building-container">

        <label for="floorSelector">Floor:</label>
        <select id="floorSelector"></select> <!-- as opções de piso vão aparecer dinâmicamente conforme o edifício selecionado -->

        <button id="reloadButton">Go</button>

        <script>
            const floorSelector = document.getElementById('floorSelector');

            floorSelector.addEventListener('change', logSelection);

            const floorMapping = {
                'A': 2,
                'B': 3,
                'C': 4,
                'D': 3,
            };

            function generateFloorOptions(numFloors) {
                return Array.from({ length: numFloors }, (_, i) => i + 1)
                    .map(i => `<option value="${i}">${i}</option>`)
                    .join('');
            }

            function getNumberOfFloors(building) {
                return floorMapping[building] || 0;
            }

            function logSelection() {
                const selectedFloor = floorSelector.value;
                console.log(`Selected Floor: ${selectedFloor}`);
            }
        </script>

    </div>
</div>
<script>
    function closeElevatorPopup() {
        var elevatorPopup = document.getElementById("elevatorPopup");
        elevatorPopup.style.display = "none";
    }
</script>


<div id="container">
    <script>displayViewsPanel()</script>
    <script>displayMouseHelpPanel()</script>
    <script>displayKeyboardHelpPanel()</script>
    <script>displayCreditsPanel()</script>
    <script>displaySubWindowsPanel()</script>
</div>

<script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
<script type="importmap">
    {
        "imports": {
            "three": "https://threejs.org/build/three.module.js",
            "three/addons/": "https://threejs.org/examples/jsm/"
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.0/gsap.min.js"></script>

<script type="module">
    import * as THREE from "three";
    import Orientation from "../helpers/orientation.js";
    import Level from "../map/level.js";

    let level;
    const selectedBuilding = 'A';
    const selectedFloor = '1';

    function initialize(selectedBuilding, selectedFloor) {

        // Create the game
        level = new Level(
            {}, // General Parameters
            {
                enabled: true,
                introductionClips: [
                    {
                        url: "/clips/el-gringo-12613.mp3",
                        position: "initial", // Global (non-positional) audio object: ""; positional audio object: "scene x y z" (scene specific position in cartesian coordinates), "maze line column" (maze specific position in cell coordinates), "exit" (maze exit location), "initial" (player initial position), "player" (player current position), "spotlight" (spotlight current position)
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.5
                    }
                ],
                idleClips: [
                    {
                        url: "/clips/Clearing-Throat-Moderate-Speed-www.fesliyanstudios.com.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    },
                    {
                        url: "/clips/Small-Double-Cough-1-www.fesliyanstudios.com.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    },
                    {
                        url: "/clips/Yawn-A2-www.fesliyanstudios.com.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    }
                ],
                jumpClips: [
                    {
                        url: "/clips/Cheering-A6-www.fesliyanstudios.com.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    },
                    {
                        url: "/clips/Cheering-A7-www.fesliyanstudios.com.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    }
                ],
                deathClips: [
                    {
                        url: "/clips/176653326.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    },
                    {
                        url: "/clips/Horn+Squeeze+Clown.mp3",
                        position: "player",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    }
                ],
                danceClips: [
                    {
                        url: "/clips/best-buddies-12609.mp3",
                        position: "exit",
                        referenceDistance: 1.0,
                        loop: true,
                        volume: 0.5
                    }
                ],
                endClips: [
                    {
                        url: "/clips/Ba-Bum-Tss-Joke-Drum-A1-www.fesliyanstudios.com.mp3",
                        position: "exit",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 2.0
                    },
                    {
                        url: "/clips/yay-6326.mp3",
                        position: "exit",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    },
                    {
                        url: "/clips/crowd-cheer-ii-6263.mp3",
                        position: "exit",
                        referenceDistance: 1.0,
                        loop: false,
                        volume: 0.75
                    }
                ],
                credits: "Sound clips downloaded from <a href='https://www.dreamstime.com/' target='_blank' rel='noopener'>Dreamstime</a>, <a href='https://www.fesliyanstudios.com/' target='_blank' rel='noopener'>Fesliyan Studios</a> and <a href='https://pixabay.com/' target='_blank' rel='noopener'>Pixabay</a>."
            }, // Audio parameters
            {
                skyboxes: [
                    { // Stormy days
                        name: "Stormy days",
                        texturePath: "/cube_textures/envmap_stormydays/",
                        texturePositiveXUrl: "stormydays_ft.jpg",
                        textureNegativeXUrl: "stormydays_bk.jpg",
                        texturePositiveYUrl: "stormydays_up.jpg",
                        textureNegativeYUrl: "stormydays_dn.jpg",
                        texturePositiveZUrl: "stormydays_rt.jpg",
                        textureNegativeZUrl: "stormydays_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/stormy-days-skybox' target='_blank' rel='noopener'>Jockum Skoglund (hipshot)</a>."
                    },
                    { // Miramar
                        name: "Miramar",
                        texturePath: "/cube_textures/red-eclipse-skyboxes/skyboxes/",
                        texturePositiveXUrl: "miramar_ft.jpg",
                        textureNegativeXUrl: "miramar_bk.jpg",
                        texturePositiveYUrl: "miramar_up.jpg",
                        textureNegativeYUrl: "miramar_dn.jpg",
                        texturePositiveZUrl: "miramar_rt.jpg",
                        textureNegativeZUrl: "miramar_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/red-eclipse-skyboxes' target='_blank' rel='noopener'>Red Eclipse</a>."
                    },
                    { // Flat sunset
                        name: "Flat sunset",
                        texturePath: "/cube_textures/red-eclipse-skyboxes/skyboxes/",
                        texturePositiveXUrl: "sunsetflat_ft.jpg",
                        textureNegativeXUrl: "sunsetflat_bk.jpg",
                        texturePositiveYUrl: "sunsetflat_up.jpg",
                        textureNegativeYUrl: "sunsetflat_dn.jpg",
                        texturePositiveZUrl: "sunsetflat_rt.jpg",
                        textureNegativeZUrl: "sunsetflat_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/red-eclipse-skyboxes' target='_blank' rel='noopener'>Red Eclipse</a>."
                    },
                    { // Calm sea
                        name: "Calm sea",
                        texturePath: "/cube_textures/xonotic-skyboxes/skyboxes/calm_sea/",
                        texturePositiveXUrl: "calm_sea_ft.jpg",
                        textureNegativeXUrl: "calm_sea_bk.jpg",
                        texturePositiveYUrl: "calm_sea_up.jpg",
                        textureNegativeYUrl: "calm_sea_dn.jpg",
                        texturePositiveZUrl: "calm_sea_rt.jpg",
                        textureNegativeZUrl: "calm_sea_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/xonotic-skyboxes' target='_blank' rel='noopener'>Xonotic</a>."
                    },
                    { // Distant sunset
                        name: "Distant sunset",
                        texturePath: "/cube_textures/xonotic-skyboxes/skyboxes/distant_sunset/",
                        texturePositiveXUrl: "distant_sunset_ft.jpg",
                        textureNegativeXUrl: "distant_sunset_bk.jpg",
                        texturePositiveYUrl: "distant_sunset_up.jpg",
                        textureNegativeYUrl: "distant_sunset_dn.jpg",
                        texturePositiveZUrl: "distant_sunset_rt.jpg",
                        textureNegativeZUrl: "distant_sunset_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/xonotic-skyboxes' target='_blank' rel='noopener'>Xonotic</a>."
                    },
                    { // Exosystem
                        name: "Exosystem",
                        texturePath: "/cube_textures/xonotic-skyboxes/skyboxes/exosystem/",
                        texturePositiveXUrl: "exosystem_ft.jpg",
                        textureNegativeXUrl: "exosystem_bk.jpg",
                        texturePositiveYUrl: "exosystem_up.jpg",
                        textureNegativeYUrl: "exosystem_dn.jpg",
                        texturePositiveZUrl: "exosystem_rt.jpg",
                        textureNegativeZUrl: "exosystem_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/xonotic-skyboxes' target='_blank' rel='noopener'>Xonotic</a>."
                    },
                    { // Heaven
                        name: "Heaven",
                        texturePath: "/cube_textures/xonotic-skyboxes/skyboxes/heaven/",
                        texturePositiveXUrl: "heaven_ft.jpg",
                        textureNegativeXUrl: "heaven_bk.jpg",
                        texturePositiveYUrl: "heaven_up.jpg",
                        textureNegativeYUrl: "heaven_dn.jpg",
                        texturePositiveZUrl: "heaven_rt.jpg",
                        textureNegativeZUrl: "heaven_lf.jpg",
                        credits: "Skybox created by <a href='https://opengameart.org/content/xonotic-skyboxes' target='_blank' rel='noopener'>Xonotic</a>."
                    }
                ],
                selected: 7
            }, // Cube texture parameters
            {
                url: `/floor_plans/building_${selectedBuilding.toLowerCase()}/floor${selectedFloor}.json`,
                helpersColor: new THREE.Color(0xff0077)
            }, // Maze parameters
            { helpersColor: new THREE.Color(0x0055ff) }, // Player parameters
            {
                intensity: 0.1
            }, // Ambient light parameters
            {
                intensity: 0.5,
                distance: 20.0,
                orientation: new Orientation(-38.7, 53.1),
                castShadow: true,
                shadow: {
                    mapSize: new THREE.Vector2(2048, 2048),
                    camera: {
                        left: -20.0,
                        right: 20.0,
                        top: 20.0,
                        bottom: -20.0,
                        near: 0.0,
                        far: 40.0
                    }
                }
            }, // Directional light parameters
            {
                visible: false,
                intensity: 90.0,
                distance: 40.0,
                angle: 4.0,
                position: new THREE.Vector3(0.0, 10.0, 0.0),
                castShadow: true,
                shadow: {
                    camera: {
                        near: 5.0,
                        far: 30.0
                    }
                }
            }, // Spotlight parameters
            {
                color: new THREE.Color(0xffffa0),
                visible: false,
                intensity: 2.0,
                distance: 5.0,
                angle: 20.0,
                orientation: new Orientation(0.0, -20.0),
                castShadow: true,
                shadow: {
                    camera: {
                        near: 0.01,
                        far: 10.0
                    }
                }
            }, // Flashlight parameters
            { type: THREE.PCFSoftShadowMap }, // Shadows parameters
            {}, // Fog parameters
            {}, // Collision detection parameters
            { view: "fixed", initialViewport: new THREE.Vector4(1, 1, 1, 1), initialDistance: 16.0, distanceMin: 8.0, distanceMax: 30.0, initialFogDensity: 0.01 }, // Fixed view camera parameters
            { view: "first-person", initialViewport: new THREE.Vector4(1, 1, 1, 1), initialOrientation: new Orientation(0.0, -10.0), orientationMax: new Orientation(180.0, 90.0), initialFogDensity: 0.01 }, // First-person view camera parameters
            { view: "third-person", initialViewport: new THREE.Vector4(1, 1, 1, 1), initialOrientation: new Orientation(50.0, -60.0), initialDistance: 10.0, distanceMin: 1, distanceMax: 2.0, initialFogDensity: 0.01 }, // Third-person view camera parameters
            { view: "top", initialViewport: new THREE.Vector4(1, 1, 1, 1), initialOrientation: new Orientation(0.0, -90.0), initialDistance: 4.0, distanceMin: 1.0, distanceMax: 16.0, initialFogDensity: 0.01 }, // Top view camera parameters
            { view: "mini-map", initialViewport: new THREE.Vector4(1, 0, 0.35, 0.25), initialOrientation: new Orientation(180.0, -90.0), initialZoom: 0.32, zoomMin: 0.32, zoomMax: 2.56 } // Mini-map view camera parameters
        );
    }
    floorSelector.innerHTML = generateFloorOptions(getNumberOfFloors(selectedBuilding));

    function animate() {
        requestAnimationFrame(animate);
        // Update the game
        level.update();
    }
    initialize(selectedBuilding, selectedFloor);
    animate();

    const reloadButton = document.getElementById('reloadButton');
    reloadButton.addEventListener('click', reloadLevel);

    document.addEventListener('reloadLevel', function (event) {
        console.log('DETAILS -> ' + JSON.stringify(event.detail));
        const selectedBuilding = event.detail.building;
        const selectedFloor = event.detail.floor;
        level.destroy();
        initialize(selectedBuilding, selectedFloor);
        animate();
    });

    function reloadLevel() {
        const selectedFloor = floorSelector.value;
        level.destroy()
        initialize(selectedBuilding, selectedFloor);
    }

</script>


</body>

</html>